$ kumactl get traffic-permissions
$ kumactl get traffic-permission allow-all-default -o yaml | yq
$ kubectl delete trafficpermissions allow-all-default
$ yq 04/05-enable-TP-exceptRedis.yaml
$ kubectl apply -f 04/05-enable-TP-exceptRedis.yaml
$ kumactl get traffic-permissions
$ kubectl apply -f 04/06-enable-TP-Redis.yaml
$ kubectl get trafficroutes
$ kubectl get trafficroutes route-all-default -o yaml | yq
$ kubectl -n kong-mesh-demo scale deployment kong-mesh-demo-backend-v1 --replicas=1
$ kubectl -n kong-mesh-demo scale deployment kong-mesh-demo-backend-v2 --replicas=1
$ kubectl get pods -n kong-mesh-demo -w
$ yq 04/07-adding-RP.yaml
$ kubectl apply -f 04/07-adding-RP.yaml
$ kumactl get traffic-routes
$ kubectl delete -f 04/07-adding-RP.yaml
$ yq 04/abortFaultInjection.yaml
$ kubectl apply -f 04/abortFaultInjection.yaml
$ kubectl delete -f 04/abortFaultInjection.yaml
$ yq 04/delayFaultInjection.yaml
$ kubectl apply -f 04/delayFaultInjection.yaml
$ kubectl delete -f 04/delayFaultInjection.yaml
$ yq 04/bandwidthFaultInjection.yaml
$ kubectl apply -f 04/bandwidthFaultInjection.yaml
$ kubectl delete -f 04/bandwidthFaultInjection.yaml
$ yq 04/healthCheck.yaml
$ kubectl apply -f 04/healthCheck.yaml
$ kubectl delete -f 04/healthCheck.yaml
$ kubectl -n kong-mesh-demo scale deployment kong-mesh-demo-backend-v1 --replicas=3
$ kubectl -n kong-mesh-demo scale deployment kong-mesh-demo-backend-v2 --replicas=3
$ yq 03/14-cb-fault-injection.yaml
$ yq 03/15-circuit-breaker.yaml
$ kubectl apply -f 03/15-circuit-breaker.yaml
$ kubectl apply -f 03/14-cb-fault-injection.yaml
$ kubectl delete -f 03/15-circuit-breaker.yaml
$ kubectl delete -f 03/14-cb-fault-injection.yaml

$ kubectl get AccessRole admin -o yaml | yq
$ kubectl get AccessRoleBinding default -o yaml | yq
$ mkdir -p /tmp/k8s-certs
$ cd /tmp/k8s-certs
$ openssl genrsa -out backend-owner.key 2048 # Generate client key
$ openssl rand -writerand .rnd
$ openssl req -new -key backend-owner.key -subj "/CN=backend-owner" -out backend-owner.csr # Generate client certificate request
$ CSR=$(cat backend-owner.csr | base64 | tr -d "\n") && echo "apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: backend-owner
spec:
  request: $CSR
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth" | kubectl apply -f -
$ kubectl certificate approve backend-owner
$ kubectl get csr backend-owner -o jsonpath='{.status.certificate}'| base64 -d > backend-owner.crt
$ kubectl config set-credentials backend-owner \
--client-key=/tmp/k8s-certs/backend-owner.key \
--client-certificate=/tmp/k8s-certs/backend-owner.crt \
--embed-certs=true
$ kubectl config view --minify -o jsonpath='{.clusters[].name}'
$ kubectl config set-context backend-owner --cluster=default --user=backend-owner
$ kubectl config view
$ kubectl config current-context

$ cd ~/kmil-101
$ yq 04/crole.yaml
$ kubectl apply -f 04/crole.yaml

$ yq 04/croleb.yaml
$ kubectl apply -f 04/croleb.yaml

$ yq 04/rbacp.yaml
$ kubectl apply -f 04/rbacp.yaml

$ kumactl get traffic-permissions
$ kubectl delete trafficpermission -n kong-mesh-demo --all
$ kubectl config use-context backend-owner
$ kubectl apply -f 04/05-enable-TP-exceptRedis.yaml
$ kubectl get trafficpermissions
$ kubectl apply -f 04/05-enable-TP-exceptRedis.yaml --context default
$ kumactl get traffic-permissions
$ kubectl apply -f 04/06-enable-TP-Redis.yaml
$ kumactl get traffic-permissions
$ kubectl apply -f 04/06-enable-TP-Redis.yaml --context default
$ kubectl get trafficpermissions
$ echo $KUMA_DEMO_PROXY
$ kubectl config use-context default
