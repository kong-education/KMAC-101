$ ./setup-k8s.sh
$ kubectl cluster-info
$ git clone https://github.com/kong-education/kmil-101.git && cd kmil-101
$ kubectl apply -f 03/01-kong-mesh-demo-aio.yaml 
$ kubectl get pods -n kong-mesh-demo -w
$ kubectl port-forward svc/frontend -n kong-mesh-demo \
  --address 0.0.0.0 8080:8080 > /dev/null 2>&1 &
$ KONG_MESH_DEMO=https://${AVL_PRIMARY_CONTAINER_EXTERNAL_DOMAIN#?}
$ echo $KONG_MESH_DEMO
$ kubectl get all -n kong-mesh-demo
$ curl -sLX GET https://docs.konghq.com/mesh/installer.sh | VERSION="1.9.0" sh -
$ mkdir -p ~/.local/bin
$ mv $(find . -iname kumactl) ~/.local/bin/
$ source ~/.profile
$ kumactl install control-plane --license-path=/etc/kong/license.json | kubectl apply -f -
$ kubectl get pods -n kong-mesh-system -w
$ kubectl expose deployment kong-mesh-control-plane -n kong-mesh-system \
  --type=NodePort --name=kongmesh-cp --port 5681
$ kubectl patch service kongmesh-cp --namespace=kong-mesh-system  --type='json' \
  --patch='[{"op": "replace", "path": "/spec/ports/0/nodePort", "value":30001}]'
$ kumactl config control-planes add --name=kongmesh-cp \
  --address=http://$AVL_PAIRED_CONTAINER_INTERNAL_DOMAIN:30001
$ kumactl inspect meshes -o yaml | yq
$ curl -sX GET http://$AVL_PAIRED_CONTAINER_INTERNAL_DOMAIN:30001 | jq
$ echo $KUMA_MESH_GUI_URI
$ kubectl get deployments \
-n kong-mesh-demo \
-o name \
| sed -e 's/.*\///g' \
| xargs -I {} kubectl patch deployment \
-n kong-mesh-demo {} \
--type='strategic' \
--patch='{"spec":{"template":{"metadata":{"labels":{"kuma.io/sidecar-injection":"enabled"}}}}}'
$ kubectl get pods -n kong-mesh-demo -w
$ kubectl get pods -n kong-mesh-demo -o \
  jsonpath="{.items[*].spec.containers[*].image}" | tr -s '[[:space:]]' '\n'
$ kill %$(jobs -l|grep svc/frontend |awk -F"\[|\]" '{print $2}')
$ kumactl install gateway kong | kubectl apply -f -
$ kubectl patch service kong-proxy --namespace=kong-mesh-gateway --type='json' \
  --patch='[{"op": "replace", "path": "/spec/ports/0/nodePort", "value":31112}]'
$ kubectl apply -f 03/03-ingressFrontEnd.yaml
$ echo $KUMA_DEMO_PROXY
$ kubectl get pods -n kong-mesh-demo \
  -o=jsonpath='{range .items[*]}{.metadata.name}{"\n"}{.metadata.labels}{"\n"}{end}'
$ kumactl get meshes
$ kubectl apply -f 03/mTLS.yaml
$ kumactl get secrets
$ kumactl get meshes
$ kumactl inspect dataplanes -o json | jq '.items[]|.name,.dataplaneInsight.mTLS'
